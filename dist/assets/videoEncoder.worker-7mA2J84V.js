(function(){"use strict";importScripts("https://cdn.jsdelivr.net/npm/mp4-muxer@5.2.2/build/mp4-muxer.min.js");let a=null,e=null,i=0;self.onmessage=async function(r){const{type:t,data:s}=r.data;switch(t){case"init":await d(s);break;case"frame":await l(s);break;case"finish":await f();break;case"abort":p();break}};async function d(r){const{width:t,height:s,fps:c,filename:n}=r;i=0;try{if(typeof VideoEncoder>"u")throw new Error("WebCodecs API not supported in this browser");a=new Mp4Muxer.Muxer({target:new Mp4Muxer.ArrayBufferTarget,video:{codec:"avc",width:t,height:s},fastStart:"in-memory"}),e=new VideoEncoder({output:(o,u)=>{a.addVideoChunk(o,u)},error:o=>{console.error("VideoEncoder error:",o),self.postMessage({type:"error",error:o.message})}}),await e.configure({codec:"avc1.42001f",width:t,height:s,bitrate:5e6,framerate:c,latencyMode:"quality",avc:{format:"avc"}}),self.postMessage({type:"ready"})}catch(o){console.error("Failed to initialize encoder:",o),self.postMessage({type:"error",error:o.message})}}async function l(r){const{imageData:t,timestamp:s,duration:c}=r;if(!e||e.state!=="configured"){self.postMessage({type:"error",error:"Encoder not ready"});return}try{const n=new VideoFrame(t,{timestamp:s,duration:c});e.encode(n,{keyFrame:!0}),n.close(),i++,self.postMessage({type:"progress",frameCount:i})}catch(n){console.error("Frame encoding error:",n),self.postMessage({type:"error",error:n.message})}}async function f(){if(!e||!a){self.postMessage({type:"error",error:"Encoder not initialized"});return}try{await e.flush(),e.close(),a.finalize();const r=a.target.buffer,t=new Blob([r],{type:"video/mp4"});self.postMessage({type:"complete",blob:t,frameCount:i})}catch(r){console.error("Finalization error:",r),self.postMessage({type:"error",error:r.message})}}function p(){try{e&&e.state!=="closed"&&e.close(),a=null,e=null,i=0}catch(r){console.error("Abort error:",r)}self.postMessage({type:"aborted"})}})();
